---
title: "Multilevel Mediation Analysis Report"
output: pdf_document
params:
  csv_input: NA
  fileName: NA
  num_var_1: NA
  num_var_2: NA
  num_var_3: NA
  fact_var: NA
  num_bootstrap_replicates: NA
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE)
```
#### Report by LSU

#### A report generated from `r paste(params$fileName, "on", Sys.Date())`.

```{r}
library(shiny)
library(shinythemes)
library(data.table)
library(ggplot2)
library(mlma)
library(fresh)
library(readxl)
library(stringr)
library(tidyverse)
library(xlsx)
library(ggdag)
library(rmarkdown)
library(tinytex)

#Put the data frame into data_input
data_input <- {
    req(params$csv_input)
    if(str_ends(params$csv_input, "csv")) 
    {
      read.csv(params$csv_input)
    }
    else if (str_ends(params$csv_input, "(xlsx|xls)")) 
    {
      read.xlsx(params$csv_input, sheetIndex = 1)
    }
    else if(str_ends(params$csv_input, "txt"))
    {
      read.table(params$csv_input, header = TRUE)
    }
}
```

# Graphic Outputs
```{r}
#NUMERICAL OUTPUT WITH AND WITHOUT BOOTSTRAPPING
y <- data_input[,params$num_var_2]
lv <- data_input[,params$fact_var]

#Putting x vars into dataframe
x <- matrix(0,length(data_input[,params$num_var_1[1]]),0)
for(val in 1:length(params$num_var_1)){
   x <- cbind(x,data_input[,params$num_var_1[val]])
}
x <- data.frame(x)

names = c()
for(val in 1:length(params$num_var_1)){
  names <- append(names, params$num_var_1[val])
}
names(x) = names

#Putting m vars into dataframe
m <- matrix(0,length(data_input[,params$num_var_3[1]]),0)
for(val in 1:length(params$num_var_3)){
    m <- cbind(m,data_input[,params$num_var_3[val]])
}
m <- data.frame(m)

names = c()
for(val in 1:length(params$num_var_3)){
  names <- append(names, params$num_var_3[val])
}
names(m) = names

sim.111=list(x=x,m=m,y=y,level=lv)
data2<-data.org(x=data.frame(sim.111$x), m=data.frame(sim.111$m), 
                f10y=list(1,c("x^2","sqrt(x+6)")), 
                f20ky=list(1,c("x","x^3")), 
                f10km=list(matrix(c(1,1),1),"log(x+2)"), level=sim.111$level)
temp2<-mlma(y=sim.111$y, data1=data2)
tmp2.boot<-boot.mlma(y=sim.111$y, data1=data2, boot=params$num_bootstrap_replicates,echo=F)
plot(tmp2.boot)
```

# Model Statistics I
```{r}
summary(temp2)
```

# Model Statistics II
```{r}
summary(tmp2.boot)
```

# DAG Visualization
```{r}
tidy_ggdag <- dagify(
    y ~ x + m1 + m2 + m3 + lv,
    m1 ~ x + lv,
    m2 ~ x + lv,
    m3 ~ x + lv,
    exposure = "x",
    outcome = "y",
    labels = c("x" = params$num_var_1[1], 
              "y" = params$num_var_2,
              "m1" = params$num_var_3[1],
              "m2" = params$num_var_3[2],
              "m3" = params$num_var_3[3],
              "lv" = params$fact_var)
  )

ggdag_status(tidy_ggdag)
```
